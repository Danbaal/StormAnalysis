
##Health and Economic Impact of Weather Events in the US in the 21st century

#####Daniel LÃ³pez Urbano
######January 25, 2015


####Abstract

Storms and other severe weather events can cause both public health and economic problems for communities and municipalities. Many severe events can result in fatalities, injuries, and property damage, and preventing such outcomes to the extent possible is a key concern.

In this report we will explore the U.S. National Oceanic and Atmospheric Administration's (NOAA) storm database. This database tracks characteristics of major storms and weather events in the United States, including when and where they occur, as well as estimates of any fatalities, injuries, and property damage.

###Data Processing

First we need to download and load the data from NOAA.

```{r DataLoading}

#Function to download the data -------------------------------------
read_data <- function(fileName, source_url) {  
  if (!file.exists(fileName)) {
    download.file(source_url, destfile = fileName, method = "curl")
  }
  dataset <- read.csv(fileName, stringsAsFactors=FALSE)
  dataset
}
#-------------------------------------------------------------------

#Downloading and Loading the Data
stormData <- read_data("repdata-data-StormData.csv.bz2", 
                       "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2")

data_dim <- dim(stormData) #Dimensions of the Data
evtype_afer <- length(unique(stormData$EVTYPE)) #985 unique event types

```

The data contains `r data_dim[1]` records and `r data_dim[2]` variables. 

For the purpose of this study we have special interest in the variable 'EVTYPE', which tells us the type of weather event for each record. We find `r evtype_afer` unique event types, which is rather a high number. We need to do some cleaning.


There's no a standard format to name the events and we can find cases like `Frost/Freeze`, `FROST/FREEZE` and `FROST\\FREZE` which obviously refer to the same type of event. --So we convert to lower case and remove punctuations.--

```{r Cleaning}

#---- Cleaning the Data ---------
events <- tolower(stormData$EVTYPE) #all characters to lowercase
events <- gsub("[[:blank:][:punct:]+]", " ", events) #cleaning punct. characters

```

We can find several event types containing the word 'tornado' or 'flood'.
Queremos hacer el analisis en terminos generales, sin considerar por separado diferentes tipos de tornado, asi que haremos limpieza de los datos.

```{r EVTYPEGrouping}

events <- gsub(".*tornado.*", "tornado", events)
events <- gsub(".*flood.*", "flood", events)
events[ (grepl(".*tstm.*",events) | grepl(".*thunderstorm.*",events))  & grepl(".*wind.*",events)] <- "thunderstorm wind"
events <- gsub(".*hurricane.*", "hurricane", events)
events <- gsub(".*drought.*", "drought", events)
events <- gsub(".*heat.*", "heat", events)
events <- gsub(".*hail.*", "hail", events)
events[grepl(".*ice.*",events) | grepl(".*snow.*",events)] <- "snow and ice"

#number of unique event types after cleaning
evtype_before <- length(unique(events))

#update the dataframe
stormData$EVTYPE <- events

```
Now we have `r evtype_before` unique event types, and is time to sumarize the data we need.

The events in the database start in the year 1950 and end in November 2011. In the earlier years of the database there are generally fewer events recorded, most likely due to a lack of good records. If we want to compare the severity of different event types properly, we must be sure that the events were equally recorded in the period of time we look. That's why we are focusing th analysis in the 21st century, because we know that the data is more reliable for our propuse. So we remove from the dataset all records of events that hapen before the 1-1-2001

```{r XXICentury}

stormData$DATE <- as.Date(stormData$BGN_DATE, '%m/%d/%Y')
stormData <- subset(stormData, as.Date("1/1/2001" , "%m/%d/%Y") < DATE)

```

<- recuento de datos...

The last thing to be done before sumarizeing the data is to remove all he variables we don't need for the analysis.

```{r VariableFiltering}

#Selecting the variables we need for the analysis
stormData <- stormData[,c('EVTYPE','PROPDMG','PROPDMGEXP','CROPDMG',
                          'CROPDMGEXP','DATE', 'FATALITIES', 'INJURIES')]

```

###Data summarizing

Know we are done with the data processing and we're going to starting sumerizeing

#### Health Damage

To find what events are most harmful to population health, the number of casualties are aggregated by the event type. Once aggregated, we can get the top 10 of the events that are the ones that will be shown in detail. The rest of the events will be grouped as "others".

```{r HelthSummarize}
library(plyr)
#Calculate the damage to population health that causes each event type
casualities <- ddply(stormData, .(EVTYPE), summarize,
                    FATAL = sum(FATALITIES),
                    INJUR = sum(INJURIES))

#Top 10 of the most harmful events
health_top10 <- head(casualities[order(casualities$FATAL + casualities$INJUR, decreasing=T),] , 10)
health_top10_names <- health_top10$EVTYPE #names of the top10

#Grouping events that are'nt in top10
stormData_others <- stormData
stormData_others$EVTYPE[!(stormData_others$EVTYPE %in% health_top10_names)] <- "others"

#Summarizeing again
casualities <- ddply(stormData_others, .(EVTYPE), summarize,
                     FATAL = sum(FATALITIES),
                     INJUR = sum(INJURIES))
#Total Casualities
total_casualities <- sum(casualities$FATAL + casualities$INJUR)

#Preparing the data for a nice plot

fatalities_p <- casualities[,1:2]
names(fatalities_p) <- c("EVENT","CASUALITIES")
fatalities_p$TYPE <- "Fatalities"

injuries_p <- casualities[,c(1,3)]
names(injuries_p) <- c("EVENT","CASUALITIES")
injuries_p$TYPE <- "Injuries"

health_plot <- rbind(fatalities_p , injuries_p)
health_plot$EVENT <- factor(health_plot$EVENT , levels = c(health_top10_names,"others"))
health_plot <- health_plot[order(health_plot$EVENT, decreasing=T),] #ordening

#Preparing the table to show numeric results

casual_table <- casualities
names(casual_table) <- c("EVENT", "FATALITIES", "INJURIES")
casual_table$EVENT <- factor(casual_table$EVENT , levels = c(health_top10_names,"others"))
casual_table <- casual_table[order(casual_table$EVENT),]
row.names(casual_table) <- 1:11
```

#### Economic loss

A similar process is implemented to summize the events that causes the biggest impact for the economy. Bbut first we need to convert the PROPDMGEXP and CROPDMGEXP fields into a usuable factor to calculate the true damage to crops and property.

```{r EconSummarize}

stormData$PROPDMGEXP<-toupper(stormData$PROPDMGEXP)
stormData$CROPDMGEXP<-toupper(stormData$CROPDMGEXP)

stormData[stormData$PROPDMGEXP %in% c("",NA, "-","?", "+"),]$PROPDMGEXP <- 0
stormData[stormData$PROPDMGEXP %in% c("H", "B"),]$PROPDMGEXP <- 2
stormData[stormData$PROPDMGEXP %in% "K",]$PROPDMGEXP <- 3
stormData[stormData$PROPDMGEXP %in% "M",]$PROPDMGEXP <- 6

stormData[stormData$CROPDMGEXP %in% c("",NA,"-","?", "+"),]$CROPDMGEXP <- 0
stormData[stormData$CROPDMGEXP %in% c("H", "B"),]$CROPDMGEXP <- 2
stormData[stormData$CROPDMGEXP %in% "K",]$CROPDMGEXP <- 3
stormData[stormData$CROPDMGEXP %in% "M",]$CROPDMGEXP <- 6

stormData$PROPDMG <- stormData$PROPDMG * 10 ** as.numeric(stormData$PROPDMGEXP)
stormData$CROPDMG <- stormData$CROPDMG * 10 ** as.numeric(stormData$CROPDMGEXP)

#Economic loss of each event type
econ_loss <- ddply(stormData, .(EVTYPE), summarize,
                   PROP = sum(PROPDMG),
                   CROP = sum(CROPDMG))
#top 10 events of economic loss
econ_top10 <- head(econ_loss[order(econ_loss$PROP + econ_loss$CROP, decreasing=T),] , 10)
econ_top10_names <- econ_top10$EVTYPE

#Grouping events that are'nt in top10
stormData_others <- stormData
stormData_others$EVTYPE[!(stormData_others$EVTYPE %in% econ_top10_names)] <- "others"

#Summarizeing again
econ_loss <- ddply(stormData_others, .(EVTYPE), summarize,
                   PROP = sum(PROPDMG),
                   CROP = sum(CROPDMG))

#Total Economic loss
total_econ_loss <- sum(econ_loss$PROP + econ_loss$CROP)

#Preparing the data for a nice plot

property_p <- econ_loss[,1:2]
names(property_p) <- c("EVENT","DAMAGE")
property_p$TYPE <- "Property"

crop_p <- econ_loss[,c(1,3)]
names(crop_p) <- c("EVENT","DAMAGE")
crop_p$TYPE <- "Crop"

econ_plot <- rbind(property_p , crop_p)
econ_plot$EVENT <- factor(econ_plot$EVENT , levels = c(econ_top10_names,"others"))
econ_plot <- econ_plot[order(econ_plot$EVENT, decreasing=T),]

#Preparing the table to show numeric results

econ_table <- econ_loss
econ_table$PROP <- round(econ_table$PROP/1000000,2)
econ_table$CROP <- round(econ_table$CROP/1000000,2)
names(econ_table) <- c("EVENT", "PROPERTY LOSS (M$)", "CROP LOSS (M$)")
econ_table$EVENT <- factor(econ_table$EVENT , levels = c(econ_top10_names,"others"))
econ_table <- econ_table[order(econ_table$EVENT),]
row.names(econ_table) <- 1:11

```


###Results

#####Health damage to the population

Here is an ordered table showing the most harmful events to the population health. 

```{r Health}

casual_table

```
Here we show the graphic of the damage to the population health.
```{r HealthPlot}
library(ggplot2)

ggplot(health_plot, aes(x=EVENT, y=CASUALITIES, fill=TYPE)) + 
    geom_bar(stat="identity") + 
    scale_fill_manual(values = c("red", "orange")) +
    theme(axis.text.x = element_text(angle = 30, hjust = 1)) + 
    ggtitle("Health Damage") +
    ylab("Casualities") +    
    xlab("Event")

```

#####Economic losses

Here is an ordered table showing the losses, in millons of dollars, caused by the most severe events.

```{r property}

econ_table

```

Here we show the graphic of the economic impact.

```{r EconPlot}

ggplot(econ_plot, aes(x=EVENT, y=DAMAGE/1000000, fill=TYPE)) + 
    geom_bar(stat="identity") + 
    scale_fill_manual(values = c("dark green", "brown")) +
    theme(axis.text.x = element_text(angle = 30, hjust = 1)) + 
    ggtitle("Economic Damage") +
    ylab("Economic loss (M$)") +    
    xlab("Event")

```


###Conclusions

Tornados are, with significance difference, the most harmful wether event to the population health. So far this century has caused `r ` fatalities and `r ` injuries, representing the `r ` of the total casualities caused by wether events in this century. Weather events that cause an excessive heat are the second most harmful to the population health, they cause `r ` less casualities than tornados, but have caused almost the same number of fatalities. Otro evento que destaca por el numero de muertes es flood,. Sumarizing casualities,